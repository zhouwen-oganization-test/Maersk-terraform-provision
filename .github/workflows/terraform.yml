---
  name: "GitHub Actions Demo"
  
  "on":
    pull_request:
    push: { branches: [main] }
  permissions:
    id-token: write # This is required for requesting the JWT
    contents: read  # This is required for actions/checkout
    
  
  jobs:
    terraform:
      runs-on: ubuntu-latest
      env:
        working-directory: AppTest/AccountTest/ServiceTest 
        TF_WORKSPACE: my-workspace 
      steps:
        - name: Check out code
          uses: actions/checkout@v2
          
        - uses: hashicorp/setup-terraform@v1
          with:
            terraform_version: 1.5.0 

        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: arn:aws:iam::129980683758:role/Github-runner-access-role
            aws-region: ap-southeast-1

        - name: Terraform Fmt
          id: fmt
          run: terraform fmt -check
          continue-on-error: true
  
        - name: Terraform init
          id: init
          run: terraform init
          working-directory: ${{ env.working-directory }}
          env:
            TF_CLI_ARGS_init: "-backend-config=role_arn=arn:aws:iam::99999999:role/my-github-actions-role -upgrade -reconfigure"
            TF_VAR_assume_role: "my-github-actions-role"
  
        - name: Terraform validate
          id: validate
          run: terraform validate
  
        - name: Terraform plan
          id: plan
          run: terraform plan -no-color
          working-directory: ${{ env.working-directory }}
          env:
            TF_VAR_assume_role: "my-github-actions-role"
  
        - name: Plan output
          id: output
          uses: actions/github-script@v3
          if: github.event_name == 'pull_request'
          env:
            PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
              const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
              ### Workspace
  
              \`${process.env.TF_WORKSPACE}\`
  
              #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
              #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
              <details><summary>Show Plan</summary>
  
              \`\`\`hcl
              ${process.env.PLAN}
              \`\`\`
  
              </details>
  
              **Pusher**: @${{ github.actor }}
              **Action**: ${{ github.event_name }}
              `;
              github.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              })
  
        - name: Terraform apply
          id: apply
          if: github.ref == 'refs/heads/main' && github.event_name == 'push'
          run: terraform apply -auto-approve -input=false
          working-directory: ${{ env.working-directory }}
          env:
            TF_VAR_assume_role: "my-github-actions-role"
  
        - name: Install InSpec
          uses: actionshub/chef-install@main
          with:
            channel: current
            project: inspec